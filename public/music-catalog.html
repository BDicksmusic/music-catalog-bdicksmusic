<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Catalog - Brandon Dicks</title>
    <link rel="stylesheet" href="variables.css"> 
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="media-styles.css">
    <style>
        /* Music Catalog Specific Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Secondary Navigation Styling */
        .secondary-nav {
            position: fixed;
            top: 60px;
            left: 0;
            width: 100vw;
            z-index: 900;
            font-size: var(--text-sm);
            background: var(--gray-200);
            color: var(--gray-300);
            display: flex;
            justify-content: flex-start;
            align-items: center;
            margin: 0;
            padding: 0 var(--space-4) 0 var(--space-3);
            text-align: left;
            height: 40px;
        }

        .secondary-button {
            text-decoration: none;
            font-weight: var(--font-semibold);
            color: var(--gray-600);
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-base);
            font-size: var(--text-x1);
            border: 1px solid transparent;
            background: transparent;
            transition: var(--transition-fast);
            cursor: pointer;
            display: inline-block;
            text-align: center;
            position: relative;
            margin: 0 var(--space-1);
        }

        .secondary-button:hover {
            color: var(--primary-500);
            background: var(--gray-200);
            transform: translateY(-1px);
        }

        .secondary-button::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: 0;
            left: 50%;
            background: var(--primary-500);
            transition: var(--transition-fast);
        }

        .secondary-button:hover::after {
            width: 100%;
            left: 0;
        }

        .secondary-button:active {
            transform: translateY(0);
            background: var(--gray-300);
        }

        body {
            padding-top: 100px; /* Account for both navs (60px + 40px) */
        }

        /* Main Opening Section Styling */
        .main-opening {
            background: var(--gray-50);
            padding: 2rem 1rem;
            text-align: center;
            border-bottom: 1px solid var(--gray-200);
        }

        .main-opening-header {
            margin-bottom: 1rem;
        }

        .main-opening-header h1 {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--gray-900);
            margin: 0;
        }

        .main-opening-content {
            max-width: 500px;
            margin: 0 auto;
        }

        .main-opening-content p {
            font-size: 0.9rem;
            line-height: 1.4;
            color: var(--gray-600);
            margin: 0;
        }

        .catalog-hero {
            background: var(--gray-100);
            color: var(--gray-800);
            padding: 2rem 1rem;
            text-align: center;
            border-bottom: 1px solid var(--gray-200);
        }

        .catalog-hero-content {
            max-width: 600px;
            margin: 0 auto;
            text-align: center;
        }

        .catalog-hero h1 {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--gray-900);
        }

        .catalog-hero p {
            font-size: 0.9rem;
            line-height: 1.4;
            color: var(--gray-600);
            max-width: 500px;
            margin: 0 auto;
        }

        .catalog-filters {
            background: transparent;
            padding: 0.75rem 1rem;
            margin: 0;
        }

        .filter-section {
            margin-bottom: 0;
        }

        .filter-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        .search-box {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .search-box:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .filter-select {
            padding: 0.75rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .filter-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .filter-tag {
            background: var(--primary-100);
            color: var(--primary-700);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-tag .remove {
            cursor: pointer;
            font-weight: bold;
            opacity: 0.7;
        }

        .filter-tag .remove:hover {
            opacity: 1;
        }

        .filter-actions {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
            gap: 1rem;
            align-items: center;
            margin-top: 0.25rem;
        }

        .filter-actions .btn {
            justify-self: start;
        }

        .sort-controls-inline {
            justify-self: end;
        }

        .sort-controls-inline {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }



        .sort-controls-inline .filter-select {
            min-width: 150px;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary-500);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-600);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .btn-secondary:hover {
            background: var(--gray-300);
        }

        .catalog-results {
            padding: 1.5rem 1rem;
            overflow: hidden;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .results-count {
            color: var(--gray-600);
            font-size: 0.95rem;
        }



        .compositions-grid {
            display: flex;
            flex-direction: column;
            gap: 0;
            margin: 0 -0.1rem;
        }

        .composition-card {
            background: white;
            border-bottom: 1px solid var(--gray-150);
            padding: 0.75rem 0;
            margin: 0 -2rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: calc(100% + 4rem);
            cursor: pointer;
            text-decoration: none;
            color: inherit;
        }

        .composition-card:hover {
            background-color: var(--gray-50);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            z-index: 1;
            position: relative;
        }

        .composition-card:first-child {
            border-top: 1px solid var(--gray-150);
        }

        .composition-main-info {
            display: flex;
            align-items: center;
            flex: 1;
            gap: 2.5rem;
            padding-left: 2rem;
        }

        .composition-title-section {
            flex: 2;
            min-width: 200px;
        }

        .composition-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 0.3rem;
            line-height: 1.3;
        }

        .composition-instrumentation {
            color: var(--gray-600);
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .composition-details-section {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 1.25rem;
        }

        .composition-year {
            background: var(--primary-100);
            color: var(--primary-700);
            font-size: 0.8rem;
            font-weight: 600;
            padding: 0.3rem 0.8rem;
            border-radius: 14px;
            white-space: nowrap;
            flex-shrink: 0;
            border: 1px solid var(--primary-200);
        }

        .composition-duration {
            color: var(--gray-500);
            font-size: 0.85rem;
            font-weight: 500;
            white-space: nowrap;
            flex-shrink: 0;
            padding: 0.1rem 0;
        }

        .composition-meta {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .meta-tag {
            background: var(--gray-100);
            color: var(--gray-600);
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            white-space: nowrap;
        }

        .composition-actions {
            min-width: 120px;
            margin-left: 2.5rem;
            padding-right: 2rem;
            flex-shrink: 0;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            border-radius: 6px;
        }

        .composition-buy-btn {
            width: 100%;
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            border-radius: 6px;
            background: var(--primary-500);
            color: white;
            border: none;
            cursor: pointer;
            text-decoration: none;
            display: block;
            text-align: center;
            transition: all 0.3s ease;
        }

        .composition-buy-btn:hover {
            background: var(--primary-600);
            transform: translateY(-1px);
        }

        .loading-state {
            text-align: center;
            padding: 4rem 2rem;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--gray-200);
            border-top: 3px solid var(--primary-500);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--gray-600);
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--gray-700);
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Tablet Responsive - 1080px breakpoint */
        @media (max-width: 1080px) {
            .filter-row {
                display: grid;
                grid-template-columns: 1fr 1fr 1fr 1fr;
                grid-template-rows: auto auto;
                gap: 0.75rem;
            }

            /* Search goes to top row, spans 2 columns */
            .filter-section:nth-child(1) {
                grid-column: 1 / 3;
                order: 1;
            }
            
            /* Other filters follow in order */
            .filter-section:nth-child(2) {
                order: 2;
            }
            
            .filter-section:nth-child(3) {
                order: 3;
            }
            
            .filter-section:nth-child(4) {
                order: 4;
            }
            
            .filter-section:nth-child(5) {
                order: 5;
            }

            .filter-actions {
                display: grid;
                grid-template-columns: 1fr 1fr 1fr 1fr;
                gap: 0.75rem;
                align-items: center;
                margin-top: 0.25rem;
            }

            .filter-actions .btn {
                grid-column: 1 / 3;
                justify-self: start;
            }

            .sort-controls-inline {
                grid-column: 3 / 5;
                justify-self: end;
            }
        }

        /* Mobile Responsive - 768px breakpoint */
        @media (max-width: 768px) {
            .main-opening {
                padding: 1.5rem 0.75rem;
            }
            
            .main-opening-header h1 {
                font-size: 1.5rem;
            }

            .main-opening-content p {
                font-size: 0.85rem;
            }
            
            .catalog-hero {
                padding: 1.5rem 0.75rem;
            }
            
            .catalog-hero h1 {
                font-size: 1.5rem;
            }

            .catalog-hero p {
                font-size: 0.85rem;
            }

            .catalog-filters {
                padding: 0.75rem 1rem;
                margin: 0;
            }

            .filter-row {
                display: grid;
                grid-template-columns: 1fr 1fr;
                grid-template-rows: auto auto auto;
                gap: 0.75rem;
            }

            /* Search spans full width on top row */
            .filter-section:nth-child(1) {
                grid-column: 1 / 3;
                order: 1;
            }
            
            /* Two filters per row for remaining filters */
            .filter-section:nth-child(2) {
                order: 2;
            }
            
            .filter-section:nth-child(3) {
                order: 3;
            }
            
            .filter-section:nth-child(4) {
                order: 4;
            }
            
            .filter-section:nth-child(5) {
                order: 5;
            }

            .filter-actions {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 0.75rem;
                align-items: center;
                grid-column: 1 / 3;
            }

            .filter-actions .btn {
                justify-self: start;
            }

            .sort-controls-inline {
                justify-self: end;
            }

            .catalog-results {
                padding: 1.25rem 0.75rem;
            }

            .results-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .composition-card {
                flex-direction: column;
                align-items: flex-start;
                padding: 0.75rem 0;
                margin: 0 -1rem;
                width: calc(100% + 2rem);
            }

            .composition-main-info {
                flex-direction: column;
                gap: 1.25rem;
                width: 100%;
                margin-bottom: 1.25rem;
                padding-left: 1rem;
            }

            .composition-details-section {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
                width: 100%;
            }

            .composition-actions {
                margin-left: 0;
                width: 100%;
                min-width: unset;
                padding-right: 1rem;
                margin-top: 0.5rem;
            }

            .composition-meta {
                margin-top: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <nav>
        <div class="nav-container">
            <a href="index.html" class="logo">BRANDON DICKS</a>
            <div class="nav-right">
                <ul class="nav-menu">
                    <li class="nav-item"><a href="media.html" class="nav-link">Media</a></li>
                    <li class="nav-item dropdown">
                        <a href="#" class="nav-link">News</a>
                        <ul class="dropdown-menu">
                            <li><a href="news.html">Latest News</a></li>
                            <li><a href="updates.html">Updates</a></li>
                            <li><a href="events.html">Events</a></li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown">
                        <a href="#" class="nav-link">Teaching Material</a>
                        <ul class="dropdown-menu">
                            <li><a href="exercises.html">Exercises</a></li>
                            <li><a href="tutorials.html">Tutorials</a></li>
                            <li><a href="resources.html">Resources</a></li>
                        </ul>
                    </li>
                    <li class="nav-item"><a href="about.html" class="nav-link">About</a></li>
                    <li class="nav-item dropdown">
                        <a href="#" class="nav-link">Contact</a>
                        <ul class="dropdown-menu">
                            <li><a href="contact.html">Get in Touch</a></li>
                            <li><a href="booking.html">Book a Lesson</a></li>
                            <li><a href="inquiries.html">General Inquiries</a></li>
                        </ul>
                    </li>
                </ul>
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle dark mode" style="margin-right: 0.5rem;">
                    <svg class="sun-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                    <svg class="moon-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                </button>
                <button class="music-catalog-btn"><a href="music-catalog.html">Music Catalog</a></button>
                <div class="hamburger">
                    <span></span>
                    <span></span>   
                    <span></span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Secondary Navigation -->
    <nav class="secondary-nav">
        <a href="/composer" class="secondary-button">Composer</a>
        <a href="/trumpeter" class="secondary-button">Trumpeter</a>
        <a href="/educator" class="secondary-button">Educator</a>
    </nav>


    <!-- Main Opening Section -->
    <section class="main-opening">
        <div class="main-opening-header">
            <h1>Music Catalog</h1>
        </div>
        <div class="main-opening-content">
            <p>This part of the website includes the full catalog of compositions created by Brandon Dicks. You can learn more about each composition by clicking the name of the work. There is a specific page for each work that includes a perusal score, example parts [if applicable], audio example, and download links for those compositions that are available. <strong>Every composition is available for purchase.</strong> If a work is not available for download, you can contact Brandon directly to get a quote for the piece and get your own copy of the composition. Compositions are also available in physical form if requested by the ensemble/individual.</p>
        </div>
    </section>
    
    <!-- Filtering System -->
    <section class="catalog-filters">
        <div class="filter-row">
            <div class="filter-section">
                <input type="text" id="search" class="search-box" placeholder="Search by title, instrumentation, or keywords...">
            </div>

            <div class="filter-section">
                <select id="category" class="filter-select">
                    <option value="">All Categories</option>
                    <option value="compositions">Original Compositions</option>
                    <option value="arrangements">Arrangements</option>
                </select>
            </div>

            <div class="filter-section">
                <select id="ensemble-type" class="filter-select">
                    <option value="">All Ensemble Types</option>
                    <option value="solo">Solo Works</option>
                    <option value="chamber">Chamber Ensemble</option>
                    <option value="large-ensemble">Large Ensemble</option>
                    <option value="brass">Brass Ensemble</option>
                    <option value="wind">Wind Ensemble</option>
                </select>
            </div>

            <div class="filter-section">
                <select id="instrumentation" class="filter-select">
                    <option value="">All Instrumentations</option>
                    <option value="trumpet">Trumpet</option>
                    <option value="brass-quartet">Brass Quartet</option>
                    <option value="brass-quintet">Brass Quintet</option>
                    <option value="brass-trio">Brass Trio</option>
                    <option value="wind-ensemble">Wind Ensemble</option>
                    <option value="piano">With Piano</option>
                </select>
            </div>

            <div class="filter-section">
                <select id="difficulty" class="filter-select">
                    <option value="">Any Difficulty</option>
                    <option value="beginner">Beginner</option>
                    <option value="intermediate">Intermediate</option>
                    <option value="advanced">Advanced</option>
                    <option value="professional">Professional</option>
                </select>
            </div>
        </div>

        <div class="filter-tags" id="active-filters"></div>

        <div class="filter-actions">
            <button class="btn btn-secondary" id="clear-filters">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
                Clear All
            </button>
            <div class="sort-controls-inline">
                <select id="sort-by-inline" class="filter-select">
                    <option value="title">Sort: Title A-Z</option>
                    <option value="title-desc">Sort: Title Z-A</option>
                    <option value="year">Sort: Year (Newest)</option>
                    <option value="year-desc">Sort: Year (Oldest)</option>
                    <option value="duration">Sort: Duration (Shortest)</option>
                    <option value="duration-desc">Sort: Duration (Longest)</option>
                </select>
            </div>
        </div>
    </section>

    <!-- Results Section -->
    <section class="catalog-results">
        <div class="results-header">
            <div class="results-count" id="results-count">Loading compositions...</div>
        </div>

        <!-- Loading State -->
        <div class="loading-state" id="loading-state">
            <div class="loading-spinner"></div>
            <p>Loading compositions from the catalog...</p>
        </div>

        <!-- Compositions Grid -->
        <div class="compositions-grid" id="compositions-grid" style="display: none;">
            <!-- Compositions will be dynamically loaded here -->
        </div>

        <!-- Empty State -->
        <div class="empty-state" id="empty-state" style="display: none;">
            <h3>No compositions found</h3>
            <p>Try adjusting your filters to see more results, or <a href="#" id="clear-filters-link">clear all filters</a> to view the complete catalog.</p>
        </div>
    </section>

    <script>
        // Music Catalog JavaScript
        let allCompositions = [];
        let filteredCompositions = [];
        let activeFilters = {};

        // DOM Elements
        const searchInput = document.getElementById('search');
        const categorySelect = document.getElementById('category');
        const ensembleTypeSelect = document.getElementById('ensemble-type');
        const instrumentationSelect = document.getElementById('instrumentation');
        const difficultySelect = document.getElementById('difficulty');
        const sortSelect = document.getElementById('sort-by-inline');
        const clearFiltersBtn = document.getElementById('clear-filters');
        const activeFiltersContainer = document.getElementById('active-filters');
        const resultsCount = document.getElementById('results-count');
        const loadingState = document.getElementById('loading-state');
        const compositionsGrid = document.getElementById('compositions-grid');
        const emptyState = document.getElementById('empty-state');

        // Initialize the catalog
        document.addEventListener('DOMContentLoaded', function() {
            loadCompositions();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Real-time search
            searchInput.addEventListener('input', debounce(applyFilters, 300));
            
            // Filter changes
            [categorySelect, ensembleTypeSelect, instrumentationSelect, difficultySelect].forEach(select => {
                select.addEventListener('change', applyFilters);
            });

            // Sort changes
            sortSelect.addEventListener('change', applySorting);

            // Button clicks
            clearFiltersBtn.addEventListener('click', clearAllFilters);
            document.getElementById('clear-filters-link').addEventListener('click', clearAllFilters);
        }

        async function loadCompositions() {
            try {
                showLoadingState();
                
                const response = await fetch('/api/compositions');
                const data = await response.json();
                
                if (data.success) {
                    allCompositions = data.compositions;
                    filteredCompositions = [...allCompositions];
                    renderCompositions();
                    updateResultsCount();
                    hideLoadingState();
                } else {
                    throw new Error('Failed to load compositions');
                }
            } catch (error) {
                console.error('Error loading compositions:', error);
                showEmptyState();
                hideLoadingState();
            }
        }

        function applyFilters() {
            // Get current filter values
            const filters = {
                search: searchInput.value.toLowerCase().trim(),
                category: categorySelect.value,
                ensembleType: ensembleTypeSelect.value,
                instrumentation: instrumentationSelect.value,
                difficulty: difficultySelect.value
            };

            activeFilters = filters;

            // Filter compositions
            filteredCompositions = allCompositions.filter(composition => {
                // Search filter
                if (filters.search) {
                    const searchableText = [
                        composition.title,
                        composition.instrumentation,
                        composition.description || '',
                        composition.tags?.join(' ') || ''
                    ].join(' ').toLowerCase();
                    
                    if (!searchableText.includes(filters.search)) {
                        return false;
                    }
                }

                // Category filter
                if (filters.category) {
                    if (filters.category === 'compositions' && composition.type !== 'Original') {
                        return false;
                    }
                    if (filters.category === 'arrangements' && composition.type !== 'Arrangement') {
                        return false;
                    }
                }

                // Ensemble type filter
                if (filters.ensembleType) {
                    const instrumentation = composition.instrumentation?.toLowerCase() || '';
                    switch (filters.ensembleType) {
                        case 'solo':
                            if (!instrumentation.includes('solo') && !instrumentation.includes('unaccompanied')) {
                                return false;
                            }
                            break;
                        case 'chamber':
                            if (!instrumentation.match(/(quartet|quintet|trio|sextet|septet|octet|nonet|dectet)/i)) {
                                return false;
                            }
                            break;
                        case 'large-ensemble':
                            if (!instrumentation.match(/(ensemble|band|orchestra)/i)) {
                                return false;
                            }
                            break;
                        case 'brass':
                            if (!instrumentation.toLowerCase().includes('brass')) {
                                return false;
                            }
                            break;
                        case 'wind':
                            if (!instrumentation.toLowerCase().includes('wind')) {
                                return false;
                            }
                            break;
                    }
                }

                // Instrumentation filter
                if (filters.instrumentation) {
                    const instrumentation = composition.instrumentation?.toLowerCase() || '';
                    if (!instrumentation.includes(filters.instrumentation.replace('-', ' '))) {
                        return false;
                    }
                }

                // Difficulty filter
                if (filters.difficulty) {
                    if (composition.difficulty?.toLowerCase() !== filters.difficulty.toLowerCase()) {
                        return false;
                    }
                }

                return true;
            });

            applySorting();
            renderCompositions();
            updateResultsCount();
            updateActiveFilters();
        }

        function applySorting() {
            const sortBy = sortSelect.value;
            
            filteredCompositions.sort((a, b) => {
                switch (sortBy) {
                    case 'title':
                        return a.title.localeCompare(b.title);
                    case 'title-desc':
                        return b.title.localeCompare(a.title);
                    case 'year':
                        return (b.year || 0) - (a.year || 0);
                    case 'year-desc':
                        return (a.year || 0) - (b.year || 0);
                    case 'duration':
                        return (parseInt(a.duration) || 0) - (parseInt(b.duration) || 0);
                    case 'duration-desc':
                        return (parseInt(b.duration) || 0) - (parseInt(a.duration) || 0);
                    default:
                        return 0;
                }
            });

            renderCompositions();
        }

        function renderCompositions() {
            if (filteredCompositions.length === 0) {
                showEmptyState();
                return;
            }

            hideEmptyState();
            
            const grid = compositionsGrid;
            grid.innerHTML = '';

            filteredCompositions.forEach(composition => {
                const card = createCompositionCard(composition);
                grid.appendChild(card);
            });

            grid.style.display = 'flex';
        }

        function createCompositionCard(composition) {
            const card = document.createElement('a');
            card.className = 'composition-card';
            card.href = `/composition/${composition.slug}`;
            
            // Handle duration - don't add "min" if it's already there
            let durationText = 'Duration not specified';
            if (composition.duration) {
                const duration = composition.duration.toString();
                durationText = duration.includes('min') ? duration : `${duration} min`;
            }
            
            // Only show year if it exists
            const yearElement = composition.year ? `<div class="composition-year">${composition.year}</div>` : '';
            
            card.innerHTML = `
                <div class="composition-main-info">
                    <div class="composition-title-section">
                        <h3 class="composition-title">${composition.title}</h3>
                        <div class="composition-instrumentation">${composition.instrumentation}</div>
                    </div>
                    
                    <div class="composition-details-section">
                        ${yearElement}
                        <div class="composition-duration">${durationText}</div>
                        <div class="composition-meta">
                            ${composition.type ? `<span class="meta-tag">${composition.type}</span>` : ''}
                            ${composition.difficulty ? `<span class="meta-tag">${composition.difficulty}</span>` : ''}
                        </div>
                    </div>
                </div>
                
                <div class="composition-actions">
                    <button class="composition-buy-btn" onclick="event.preventDefault(); event.stopPropagation(); window.open('${composition.purchaseUrl || '#'}', '_blank')">Buy Now</button>
                </div>
            `;

            return card;
        }

        function updateResultsCount() {
            const count = filteredCompositions.length;
            const total = allCompositions.length;
            resultsCount.textContent = `Showing ${count} of ${total} compositions`;
        }

        function updateActiveFilters() {
            activeFiltersContainer.innerHTML = '';
            
            Object.entries(activeFilters).forEach(([key, value]) => {
                if (value && value.trim()) {
                    const tag = document.createElement('div');
                    tag.className = 'filter-tag';
                    
                    let label = key.charAt(0).toUpperCase() + key.slice(1);
                    if (key === 'ensembleType') label = 'Ensemble Type';
                    
                    tag.innerHTML = `
                        ${label}: ${value}
                        <span class="remove" onclick="removeFilter('${key}')">&times;</span>
                    `;
                    
                    activeFiltersContainer.appendChild(tag);
                }
            });
        }

        function removeFilter(filterKey) {
            // Clear the specific filter
            switch (filterKey) {
                case 'search':
                    searchInput.value = '';
                    break;
                case 'category':
                    categorySelect.value = '';
                    break;
                case 'ensembleType':
                    ensembleTypeSelect.value = '';
                    break;
                case 'instrumentation':
                    instrumentationSelect.value = '';
                    break;
                case 'difficulty':
                    difficultySelect.value = '';
                    break;
            }
            
            applyFilters();
        }

        function clearAllFilters() {
            // Reset all form elements
            searchInput.value = '';
            categorySelect.value = '';
            ensembleTypeSelect.value = '';
            instrumentationSelect.value = '';
            difficultySelect.value = '';
            
            // Reset active filters
            activeFilters = {};
            
            // Show all compositions
            filteredCompositions = [...allCompositions];
            applySorting();
            renderCompositions();
            updateResultsCount();
            updateActiveFilters();
        }

        function showLoadingState() {
            loadingState.style.display = 'block';
            compositionsGrid.style.display = 'none';
            emptyState.style.display = 'none';
        }

        function hideLoadingState() {
            loadingState.style.display = 'none';
        }

        function showEmptyState() {
            emptyState.style.display = 'block';
            compositionsGrid.style.display = 'none';
        }

        function hideEmptyState() {
            emptyState.style.display = 'none';
        }

        // Debounce helper function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Theme toggle functionality (if needed)
        const themeToggle = document.getElementById('theme-toggle');
        if (themeToggle) {
            themeToggle.addEventListener('click', function() {
                document.body.classList.toggle('dark-mode');
            });
        }
    </script>
</body>
</html>